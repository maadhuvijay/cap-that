<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 889dfb02-b523-4213-821a-bb4f9fbd01b8 (2025-12-17 19:19Z) -->

# Speckit plan T027 (2025-12-17 19:19Z)

_**User (2025-12-17 02:58Z)**_

/speckit.plan T027

--- Cursor Command: speckit.plan.md ---
---
description: Execute the implementation planning workflow using the plan template to generate design artifacts.
handoffs: 
  - label: Create Tasks
    agent: speckit.tasks
    prompt: Break the plan into tasks
    send: true
  - label: Create Checklist
    agent: speckit.checklist
    prompt: Create a checklist for the following domain...
---

## User Input

```text
T027
```

You **MUST** consider the user input before proceeding (if not empty).

## Outline

1. **Setup**: Run `.specify/scripts/bash/setup-plan.sh --json` from repo root and parse JSON for FEATURE_SPEC, IMPL_PLAN, SPECS_DIR, BRANCH. For single quotes in args like "I'm Groot", use escape syntax: e.g 'I'\''m Groot' (or double-quote if possible: "I'm Groot").

2. **Load context**: Read FEATURE_SPEC and `.specify/memory/constitution.md`. Load IMPL_PLAN template (already copied).

3. **Execute plan workflow**: Follow the structure in IMPL_PLAN template to:
   - Fill Technical Context (mark unknowns as "NEEDS CLARIFICATION")
   - Fill Constitution Check section from constitution
   - Evaluate gates (ERROR if violations unjustified)
   - Phase 0: Generate research.md (resolve all NEEDS CLARIFICATION)
   - Phase 1: Generate data-model.md, contracts/, quickstart.md
   - Phase 1: Update agent context by running the agent script
   - Re-evaluate Constitution Check post-design

4. **Stop and report**: Command ends after Phase 2 planning. Report branch, IMPL_PLAN path, and generated artifacts.

## Phases

### Phase 0: Outline & Research

1. **Extract unknowns from Technical Context** above:
   - For each NEEDS CLARIFICATION → research task
   - For each dependency → best practices task
   - For each integration → patterns task

2. **Generate and dispatch research agents**:

   ```text
   For each unknown in Technical Context:
     Task: "Research {unknown} for {feature context}"
   For each technology choice:
     Task: "Find best practices for {tech} in {domain}"
   ```

3. **Consolidate findings** in `research.md` using format:
   - Decision: [what was chosen]
   - Rationale: [why chosen]
   - Alternatives considered: [what else evaluated]

**Output**: research.md with all NEEDS CLARIFICATION resolved

### Phase 1: Design & Contracts

**Prerequisites:** `research.md` complete

1. **Extract entities from feature spec** → `data-model.md`:
   - Entity name, fields, relationships
   - Validation rules from requirements
   - State transitions if applicable

2. **Generate API contracts** from functional requirements:
   - For each user action → endpoint
   - Use standard REST/GraphQL patterns
   - Output OpenAPI/GraphQL schema to `/contracts/`

3. **Agent context update**:
   - Run `.specify/scripts/bash/update-agent-context.sh cursor-agent`
   - These scripts detect which AI agent is in use
   - Update the appropriate agent-specific context file
   - Add only new technology from current plan
   - Preserve manual additions between markers

**Output**: data-model.md, /contracts/*, quickstart.md, agent-specific file

## Key rules

- Use absolute paths
- ERROR on gate failures or unresolved clarifications

--- End Command ---

---

_**Agent (model default, mode Agent)**_



---


Running the setup script to get the required paths and context.


---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd c:\dev\capthat\cap-that && bash .specify/scripts/bash/setup-plan.sh --json T027</summary>

```bash
cd c:\dev\capthat\cap-that && bash .specify/scripts/bash/setup-plan.sh --json T027
```

```
At C:\Users\maadh\AppData\Local\Temp\ps-script-6b53358f-03fb-4264-be98-911ec1e8b99d.ps1:7 char:28
+ cd c:\dev\capthat\cap-that &amp;&amp; bash .specify/scripts/bash/setup-plan.s ...
+                            ~~
The token '&amp;&amp;' is not a valid statement separator in this version.
    + CategoryInfo          : ParserError: (:) [], ParentContainsErrorRecordException
    + FullyQualifiedErrorId : InvalidEndOfLine
 

```
</details>
</tool-use>

---



---


Fixing the command for PowerShell:


---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_cmd">
<details><summary>Tool use: **run_terminal_cmd** • Run command: cd c:\dev\capthat\cap-that; bash .specify/scripts/bash/setup-plan.sh --json T027</summary>

```bash
cd c:\dev\capthat\cap-that; bash .specify/scripts/bash/setup-plan.sh --json T027
```

```
bash : The term 'bash' is not recognized as the name of a cmdlet, function, script file, or operable program. Check 
the spelling of the name, or if a path was included, verify that the path is correct and try again.
At C:\Users\maadh\AppData\Local\Temp\ps-script-9da24d1c-3423-4eef-86fa-33af5405e1fe.ps1:7 char:29
+ cd c:\dev\capthat\cap-that; bash .specify/scripts/bash/setup-plan.sh  ...
+                             ~~~~
    + CategoryInfo          : ObjectNotFound: (bash:String) [], CommandNotFoundException
    + FullyQualifiedErrorId : CommandNotFoundException
 

```
</details>
</tool-use>

---



---


Checking the `.specify` directory structure and reading the setup script:


---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** • Listed directory, 0 results</summary>
        
No results found
</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: .specify/scripts/bash/setup-plan.sh</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: specs/001-capthat-extension/tasks.md</summary>

</details>
</tool-use>

---



---


Reading the common script to understand the path logic, then manually extracting the required information:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: .specify/scripts/bash/common.sh</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "T027" in "specs/001-capthat-extension/tasks.md" • 1 match</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `specs/001-capthat-extension/tasks.md` | `- [ ] T027 [P] Define message types at `extension/types/messages.ts` (capture request/response, storage updates, export requests with TypeScript interfaces)` | L85 |


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: .specify/templates/plan-template.md</summary>

</details>
</tool-use>

---



---


Reading the required files to understand the context:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: specs/001-capthat-extension/spec.md</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: .specify/memory/constitution.md</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="glob_file_search">
<details>
<summary>Tool use: **glob_file_search** • Searched codebase "**/plan.md" • **0** result in **1** directory</summary>

Directory: **c:\dev\capthat\cap-that\specs\001-capthat-extension** (0 file)

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: specs/001-capthat-extension/implementation-plan.md</summary>

</details>
</tool-use>

---



---


Checking if `plan.md` exists and reviewing the task context for T027:


---

<tool-use data-tool-type="generic" data-tool-name="glob_file_search">
<details>
<summary>Tool use: **glob_file_search** • Searched codebase "plan.md" • **0** result in **1** directory</summary>

Directory: **c:\dev\capthat\cap-that\specs\001-capthat-extension** (0 file)

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: specs/001-capthat-extension/tasks.md</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "What message types are needed for communication between content script and service worker in the Chrome extension?" • **13** results</summary>
            
| File | Lines |
|------|-------|
| `.cursor/commands/speckit.tasks.md` | L42 |
| `.cursor/commands/speckit.clarify.md` | L30-88 |
| `.cursor/commands/speckit.plan.md` | L56 |
| `.cursor/commands/speckit.specify.md` | L41 |
| `.cursor/commands/speckit.clarify.md` | L35 |
| `.cursor/commands/speckit.checklist.md` | L38-63 |
| `.specify/scripts/bash/update-agent-context.sh` | L49 |
| `.specify/templates/spec-template.md` | L59-115 |
| `.specify/memory/constitution.md` | L47 |
| `.cursor/commands/speckit.checklist.md` | L214-260 |
| `tsconfig.json` | L37 |
| `.specify/templates/tasks-template.md` | L51-107 |
| `package.json` | L30 |

</details>
</tool-use>

---



---


Creating the implementation plan for T027. Since bash isn't available, manually determining paths and creating the plan. Starting by creating `plan.md` from the template:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: .specify/templates/plan-template.md</summary>

</details>
</tool-use>

---

Could not find file 'extension/types/index.ts' in the workspace.

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "How do content scripts communicate with service workers using postMessage in Chrome extensions?" • **11** results</summary>
            
| File | Lines |
|------|-------|
| `.cursor/commands/speckit.plan.md` | L56 |
| `.cursor/commands/speckit.tasks.md` | L42 |
| `.cursor/commands/speckit.taskstoissues.md` | L30 |
| `.cursor/commands/speckit.analyze.md` | L44 |
| `package.json` | L30 |
| `.cursor/commands/speckit.implement.md` | L48 |
| `.cursor/commands/speckit.specify.md` | L38-75 |
| `.cursor/commands/speckit.specify.md` | L41 |
| `.cursor/commands/speckit.clarify.md` | L35 |
| `.specify/scripts/bash/update-agent-context.sh` | L579-646 |
| `.specify/scripts/bash/update-agent-context.sh` | L46-121 |

</details>
</tool-use>

---



---


Creating the implementation plan for the feature. T027 (message types) will be covered in the contracts section. Creating `plan.md` from the template:


---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [-] Create plan.md from template with Technical Context and Constitution Check
- [ ] Generate research.md to resolve any NEEDS CLARIFICATION items
- [ ] Generate data-model.md with message type entities
- [ ] Generate contracts/ directory with message type definitions
- [ ] Generate quickstart.md with message passing examples
- [ ] Update agent context with new technology decisions

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: extension/background/service-worker.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: extension/content/content-script.ts</summary>

</details>
</tool-use>

---



---


Creating `plan.md` with the required sections:


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **write** • Edit file: specs/001-capthat-extension/plan.md</summary>

**Chunk 1**
Lines added: 154, lines removed: 1

```diff
@@ -1,1 +1,154 @@
- 
+ # Implementation Plan: CapThat Chrome Extension
+ 
+ **Branch**: &#96;001-capthat-extension&#96; | **Date**: 2025-01-27 | **Spec**: [spec.md](./spec.md)
+ **Input**: Feature specification from &#96;/specs/001-capthat-extension/spec.md&#96;
+ 
+ **Note**: This template is filled in by the &#96;/speckit.plan&#96; command. See &#96;.specify/templates/commands/plan.md&#96; for the execution workflow.
+ 
+ ## Summary
+ 
+ CapThat is a Chrome Extension (MV3) for capturing and organizing images into a mood board. The extension uses content scripts to detect images, a service worker for background processing, and a side panel UI for board management. Core functionality includes image capture with CORS fallback, board persistence using chrome.storage.local and IndexedDB, and export capabilities (JSON and ZIP). The implementation uses TypeScript, React, and Tailwind CSS with a strict security model.
+ 
+ ## Technical Context
+ 
+ **Language/Version**: TypeScript 5.x, JavaScript (ES2020+)  
+ **Primary Dependencies**: 
+ - Chrome Extension APIs (chrome.storage, chrome.runtime, chrome.scripting, chrome.sidePanel)
+ - React 19.2.1 for UI components
+ - Tailwind CSS 4.x for styling
+ - JSZip for ZIP export functionality
+ - Vite 5.4.0 for extension bundling
+ - Next.js 16.0.10 for Phase 2 web app integration
+ 
+ **Storage**: 
+ - chrome.storage.local for board metadata (10MB default quota)
+ - IndexedDB for image blob storage (larger quota, better for binary data)
+ - Fallback to URL-only storage if blob fetch fails
+ 
+ **Testing**: Manual testing in Chrome via "Load unpacked" extension. Unit tests are optional per project requirements.  
+ **Target Platform**: Chrome Browser (Manifest V3), Desktop (1024px+ width assumed)  
+ **Project Type**: Extension + Web (hybrid - extension at root, Next.js app in app/ directory)  
+ **Performance Goals**: 
+ - Capture appears in board within 2 seconds
+ - Panel opens within 1 second
+ - Export completes for boards up to 50 items (v1), 100 items (v1.5)
+ - Virtual scrolling handles 100+ items smoothly
+ 
+ **Constraints**: 
+ - Strict CSP (no eval, no inline scripts)
+ - Minimal permissions (activeTab over *://*/*)
+ - 100 item board limit (hard limit, warning at 80)
+ - 10MB per image size limit, 10MP dimension limit
+ - CORS limitations require fallback strategies
+ - Storage quota monitoring required
+ 
+ **Scale/Scope**: 
+ - Single user, local-first extension
+ - Up to 100 captured items per board
+ - Export support for boards up to 50 items (v1), 100 items (v1.5)
+ - Works on common websites (e-commerce, social media, content sites)
+ 
+ ## Constitution Check
+ 
+ *GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*
+ 
+ **Code Clarity &amp; Readability**: 
+ - [x] All code uses descriptive names and clear structure
+ - [x] No cryptic or overly clever implementations
+ 
+ **Simplicity First**: 
+ - [x] Chosen approach is the simplest that solves the problem
+ - [x] Any complexity is justified and documented
+ 
+ **Regular Comments**: 
+ - [x] Plan includes comment strategy for complex logic
+ - [x] Framework-specific patterns will be explained for newcomers
+ 
+ **File Organization**: 
+ - [x] File structure avoids excessive file splitting
+ - [x] Related functionality consolidated where possible
+ - [x] File separation only where clearly beneficial
+ 
+ **Violations**: None identified. Message types will be consolidated in a single &#96;messages.ts&#96; file per Constitution principle IV.
+ 
+ ## Project Structure
+ 
+ ### Documentation (this feature)
+ 
+ &#96;&#96;&#96;text
+ specs/001-capthat-extension/
+ ├── plan.md              # This file (/speckit.plan command output)
+ ├── research.md          # Phase 0 output (/speckit.plan command)
+ ├── data-model.md        # Phase 1 output (/speckit.plan command)
+ ├── quickstart.md        # Phase 1 output (/speckit.plan command)
+ ├── contracts/           # Phase 1 output (/speckit.plan command)
+ └── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
+ &#96;&#96;&#96;
+ 
+ ### Source Code (repository root)
+ 
+ &#96;&#96;&#96;text
+ cap-that/
+ ├── extension/                          # Chrome Extension
+ │   ├── manifest.json                   # MV3 manifest
+ │   ├── background/
+ │   │   └── service-worker.ts          # Background service worker
+ │   ├── content/
+ │   │   └── content-script.ts          # Content script injection
+ │   ├── ui/
+ │   │   ├── side-panel.html            # Side panel HTML
+ │   │   ├── side-panel.tsx             # React component
+ │   │   └── components/                # UI components
+ │   │       ├── Header.tsx
+ │   │       ├── ImageGrid.tsx
+ │   │       ├── ImageCard.tsx
+ │   │       ├── CapBoardPanel.tsx
+ │   │       └── ActionButton.tsx
+ │   ├── storage/
+ │   │   ├── storage-adapter.ts          # chrome.storage wrapper
+ │   │   └── indexeddb-adapter.ts       # IndexedDB wrapper
+ │   ├── export/
+ │   │   ├── json-export.ts              # JSON export logic
+ │   │   ├── zip-export.ts               # ZIP export logic
+ │   │   └── filename-sanitizer.ts       # Filename sanitization
+ │   ├── validation/
+ │   │   ├── url-validator.ts            # URL validation
+ │   │   ├── image-validator.ts          # Image validation
+ │   │   └── schema-validator.ts         # Data schema validation
+ │   └── types/
+ │       ├── index.ts                    # TypeScript types (CapturedItem, CapBoard, etc.)
+ │       └── messages.ts                 # Message type definitions (T027)
+ │
+ ├── app/                                # Next.js App (Phase 2)
+ │   ├── api/
+ │   │   └── capture/
+ │   │       └── route.ts                # POST /api/capture
+ │   ├── board/
+ │   │   └── page.tsx                    # Board view page
+ │   └── layout.tsx                      # Root layout
+ │
+ ├── shared/                             # Shared code
+ │   ├── types/
+ │   │   └── index.ts                    # Shared TypeScript types
+ │   ├── validators/
+ │   │   └── url.ts                      # URL validation
+ │   └── storage/
+ │       └── adapters.ts                 # Storage interface
+ │
+ └── specs/
+     └── 001-capthat-extension/
+         ├── spec.md                     # Main feature spec
+         ├── plan.md                     # This document
+         └── checklists/
+             ├── requirements.md
+             └── security.md
+ &#96;&#96;&#96;
+ 
+ **Structure Decision**: Hybrid structure with extension at root, Next.js app in &#96;app/&#96; directory, and shared code in &#96;shared/&#96; directory. This follows the existing project layout and allows code sharing between extension and web app.
+ 
+ ## Complexity Tracking
+ 
+ &gt; **Fill ONLY if Constitution Check has violations that must be justified**
+ 
+ No violations identified. Message types will be consolidated in a single file per Constitution principle IV.
+ 
```

</details>

</tool-use>

---



---


Generating Phase 0 and Phase 1 artifacts. Starting with research.md, then data-model.md, contracts, and quickstart.md:


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **write** • Edit file: specs/001-capthat-extension/research.md</summary>

**Chunk 1**
Lines added: 156, lines removed: 1

```diff
@@ -1,1 +1,156 @@
- 
+ # Research: CapThat Chrome Extension
+ 
+ **Feature**: 001-capthat-extension  
+ **Date**: 2025-01-27  
+ **Status**: Complete
+ 
+ ## Research Findings
+ 
+ ### Chrome Extension Message Passing (MV3)
+ 
+ **Decision**: Use &#96;chrome.runtime.sendMessage&#96; and &#96;chrome.runtime.onMessage&#96; for bidirectional communication between content scripts and service worker.
+ 
+ **Rationale**: 
+ - Standard Chrome Extension API for MV3
+ - Supports async responses via &#96;sendResponse&#96; callback
+ - Type-safe with TypeScript interfaces
+ - Isolated world communication pattern
+ 
+ **Alternatives considered**:
+ - &#96;chrome.runtime.connect&#96; (long-lived connections) - More complex, not needed for request/response pattern
+ - &#96;postMessage&#96; with window - Not secure, breaks isolation
+ - Custom event system - Unnecessary complexity
+ 
+ **Implementation Pattern**:
+ &#96;&#96;&#96;typescript
+ // Content script → Service worker
+ chrome.runtime.sendMessage({ type: 'CAPTURE_REQUEST', payload: {...} }, (response) =&gt; {
+   // Handle response
+ });
+ 
+ // Service worker → Content script
+ chrome.tabs.sendMessage(tabId, { type: 'UPDATE_UI', payload: {...} });
+ &#96;&#96;&#96;
+ 
+ ### Message Type Structure
+ 
+ **Decision**: Use discriminated union pattern with &#96;type&#96; field for message routing.
+ 
+ **Rationale**:
+ - TypeScript type narrowing works automatically
+ - Easy to validate and route messages
+ - Clear message intent
+ - Prevents invalid message shapes
+ 
+ **Alternatives considered**:
+ - Separate message classes - More verbose, unnecessary OOP
+ - String-based routing - Less type-safe
+ - Protocol buffers - Overkill for internal extension communication
+ 
+ ### Storage Strategy
+ 
+ **Decision**: Use chrome.storage.local for metadata, IndexedDB for blobs.
+ 
+ **Rationale**:
+ - chrome.storage.local: 10MB quota, synchronous API, good for small metadata
+ - IndexedDB: Larger quota, async API, better for binary data (blobs)
+ - Separation of concerns: metadata vs. binary data
+ 
+ **Alternatives considered**:
+ - All in chrome.storage.local - Limited by 10MB quota, inefficient for blobs
+ - All in IndexedDB - More complex API, overkill for small metadata
+ - File System API - Not available in extensions
+ 
+ ### CORS Handling Strategy
+ 
+ **Decision**: Multi-tier fallback: URL storage → blob fetch → tab capture (v2).
+ 
+ **Rationale**:
+ - URL storage always works (no CORS restrictions)
+ - Blob fetch works for same-origin and CORS-enabled images
+ - Tab capture provides fallback for CORS-blocked images (Phase 2)
+ 
+ **Alternatives considered**:
+ - Only URL storage - Limited functionality, no offline access
+ - Only blob fetch - Fails on many websites due to CORS
+ - Proxy server - Requires backend infrastructure, not local-first
+ 
+ ### Export Filename Sanitization
+ 
+ **Decision**: Remove path traversal characters (&#96;/&#96;, &#96;\&#96;, &#96;..&#96;, etc.) and limit length.
+ 
+ **Rationale**:
+ - Prevents path traversal attacks
+ - Ensures cross-platform compatibility
+ - Prevents filesystem errors
+ 
+ **Alternatives considered**:
+ - Allow all characters - Security risk
+ - Base64 encoding - Less user-friendly filenames
+ - UUID-only names - Less descriptive
+ 
+ ## Technology Decisions
+ 
+ ### TypeScript for Type Safety
+ 
+ **Decision**: Use TypeScript for all extension code.
+ 
+ **Rationale**:
+ - Type safety prevents runtime errors
+ - Better IDE support
+ - Self-documenting code via types
+ - Easier refactoring
+ 
+ ### React for UI Components
+ 
+ **Decision**: Use React for side panel UI.
+ 
+ **Rationale**:
+ - Component reusability
+ - State management
+ - Consistent with Next.js app (Phase 2)
+ - Good ecosystem support
+ 
+ ### Tailwind CSS for Styling
+ 
+ **Decision**: Use Tailwind CSS only (no external UI libraries).
+ 
+ **Rationale**:
+ - Utility-first approach
+ - No runtime CSS-in-JS overhead
+ - Consistent design system
+ - Matches project requirements
+ 
+ ### Vite for Extension Bundling
+ 
+ **Decision**: Use Vite for extension build process.
+ 
+ **Rationale**:
+ - Fast builds
+ - Good TypeScript support
+ - Plugin ecosystem
+ - Already configured in project
+ 
+ ## Best Practices Adopted
+ 
+ 1. **Message Validation**: All messages validated at service worker boundary
+ 2. **Error Handling**: User-friendly error messages, no internal path exposure
+ 3. **Storage Quota Monitoring**: Warn at 80% usage, enforce limits
+ 4. **Security**: Strict CSP, minimal permissions, input validation
+ 5. **Performance**: Virtual scrolling for large lists, lazy loading where appropriate
+ 
+ ## Open Questions Resolved
+ 
+ - ✅ Message passing pattern: chrome.runtime.sendMessage
+ - ✅ Storage strategy: chrome.storage.local + IndexedDB
+ - ✅ CORS handling: Multi-tier fallback
+ - ✅ Type structure: Discriminated union with &#96;type&#96; field
+ - ✅ Filename sanitization: Remove path traversal chars
+ 
+ ## References
+ 
+ - Chrome Extension MV3 Documentation: https://developer.chrome.com/docs/extensions/mv3/
+ - Chrome Extension Message Passing: https://developer.chrome.com/docs/extensions/mv3/messaging/
+ - IndexedDB API: https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API
+ - chrome.storage API: https://developer.chrome.com/docs/extensions/reference/storage/
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Create plan.md from template with Technical Context and Constitution Check
- [x] Generate research.md to resolve any NEEDS CLARIFICATION items
- [-] Generate data-model.md with message type entities
- [ ] Generate contracts/ directory with message type definitions
- [ ] Generate quickstart.md with message passing examples
- [ ] Update agent context with new technology decisions

</details>
</tool-use>

---



---


Creating data-model.md and the contracts directory:


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **write** • Edit file: specs/001-capthat-extension/data-model.md</summary>

**Chunk 1**
Lines added: 246, lines removed: 1

```diff
@@ -1,1 +1,246 @@
- 
+ # Data Model: CapThat Chrome Extension
+ 
+ **Feature**: 001-capthat-extension  
+ **Date**: 2025-01-27  
+ **Status**: Design Complete
+ 
+ ## Core Entities
+ 
+ ### CapturedItem
+ 
+ Represents a single image capture with all associated metadata.
+ 
+ **Fields**:
+ - &#96;id: string&#96; - Unique identifier (UUID v4)
+ - &#96;imageReference: ImageReference&#96; - Reference to the captured image
+ - &#96;sourceUrl: string&#96; - URL of the page where image was captured
+ - &#96;timestamp: number&#96; - Unix timestamp (milliseconds) of capture
+ - &#96;metadata?: Record&lt;string, unknown&gt;&#96; - Optional metadata (title, domain, product link, etc.)
+ - &#96;qualityIndicator?: 'url-only' | 'blob' | 'fallback'&#96; - Indicates capture quality/fallback used
+ 
+ **Validation Rules**:
+ - &#96;id&#96; must be non-empty string
+ - &#96;sourceUrl&#96; must be valid HTTP/HTTPS URL (validated via URL validator)
+ - &#96;timestamp&#96; must be positive number
+ - &#96;metadata&#96; must be serializable JSON object (no circular refs)
+ 
+ **State Transitions**: None (immutable after creation)
+ 
+ ### CapBoard
+ 
+ Represents the collection of captured items and board configuration.
+ 
+ **Fields**:
+ - &#96;items: CapturedItem[]&#96; - Array of captured items (max 100)
+ - &#96;metadata: BoardMetadata&#96; - Board-level metadata
+ - &#96;gridConfig: GridConfig&#96; - Grid layout configuration
+ - &#96;exportHistory?: ExportManifest[]&#96; - Optional history of exports
+ 
+ **Validation Rules**:
+ - &#96;items.length&#96; must be ≤ 100 (enforced before save)
+ - &#96;items&#96; array must contain valid CapturedItem objects
+ - &#96;metadata&#96; must be valid BoardMetadata object
+ 
+ **State Transitions**:
+ - Empty → Has items (on capture)
+ - Has items → Empty (on clear)
+ - Item count 79 → 80 (warning threshold)
+ - Item count 99 → 100 (hard limit)
+ 
+ ### ImageReference
+ 
+ Represents the captured image data (URL or blob).
+ 
+ **Fields**:
+ - &#96;urlOrBlob: string | BlobReference&#96; - Either image URL string or IndexedDB blob reference
+ - &#96;thumbnail?: string&#96; - Base64-encoded thumbnail for grid display
+ - &#96;dimensions?: { width: number; height: number }&#96; - Original image dimensions if available
+ - &#96;fallbackIndicator?: boolean&#96; - True if lower-quality fallback was used
+ 
+ **Validation Rules**:
+ - If &#96;urlOrBlob&#96; is string, must be valid HTTP/HTTPS/data URL
+ - If &#96;urlOrBlob&#96; is BlobReference, must have valid IndexedDB key
+ - &#96;thumbnail&#96; must be valid base64 string if present
+ - &#96;dimensions&#96; must have positive width and height if present
+ 
+ **State Transitions**: None (immutable after creation)
+ 
+ ### BoardMetadata
+ 
+ Board-level metadata and configuration.
+ 
+ **Fields**:
+ - &#96;creationDate: number&#96; - Unix timestamp of board creation
+ - &#96;lastModified: number&#96; - Unix timestamp of last modification
+ - &#96;version: string&#96; - Board data format version (semantic versioning)
+ 
+ **Validation Rules**:
+ - &#96;creationDate&#96; must be ≤ &#96;lastModified&#96;
+ - &#96;version&#96; must be valid semantic version string
+ 
+ ### GridConfig
+ 
+ Grid layout configuration.
+ 
+ **Fields**:
+ - &#96;slots: number&#96; - Number of grid slots (default: 10)
+ - &#96;columns: number&#96; - Number of columns (default: 5)
+ - &#96;virtualScrolling: boolean&#96; - Whether virtual scrolling is enabled (default: true)
+ 
+ **Validation Rules**:
+ - &#96;slots&#96; must be positive integer
+ - &#96;columns&#96; must be positive integer
+ - &#96;slots&#96; must be ≥ &#96;columns&#96;
+ 
+ ### ExportManifest
+ 
+ Represents exported board data structure.
+ 
+ **Fields**:
+ - &#96;boardMetadata: BoardMetadata&#96; - Board metadata at export time
+ - &#96;itemReferences: ExportItemReference[]&#96; - Array of item references with file mappings
+ - &#96;exportTimestamp: number&#96; - Unix timestamp of export
+ - &#96;formatVersion: string&#96; - Export format version (semantic versioning)
+ 
+ **Validation Rules**:
+ - &#96;itemReferences&#96; must be non-empty array
+ - &#96;formatVersion&#96; must be valid semantic version string
+ - JSON structure must be valid (no circular refs, valid UTF-8)
+ 
+ ### ExportItemReference
+ 
+ Reference to an exported item with file mapping.
+ 
+ **Fields**:
+ - &#96;itemId: string&#96; - ID of the captured item
+ - &#96;filename?: string&#96; - Filename in export (if image was exported)
+ - &#96;imageUrl?: string&#96; - Original image URL (if available)
+ - &#96;metadata: Record&lt;string, unknown&gt;&#96; - Item metadata
+ 
+ ## Message Types (T027)
+ 
+ ### Message Base Structure
+ 
+ All messages use discriminated union pattern with &#96;type&#96; field:
+ 
+ &#96;&#96;&#96;typescript
+ type Message = 
+   | CaptureRequestMessage
+   | CaptureResponseMessage
+   | StorageUpdateMessage
+   | ExportRequestMessage
+   | ExportResponseMessage
+   | BoardUpdateMessage
+   | ErrorMessage;
+ &#96;&#96;&#96;
+ 
+ ### CaptureRequestMessage
+ 
+ Request from content script to service worker to capture an image.
+ 
+ **Fields**:
+ - &#96;type: 'CAPTURE_REQUEST'&#96;
+ - &#96;payload: { imageUrl: string; sourceUrl: string; metadata?: Record&lt;string, unknown&gt; }&#96;
+ 
+ **Validation**:
+ - &#96;imageUrl&#96; must be valid HTTP/HTTPS/data URL
+ - &#96;sourceUrl&#96; must be valid HTTP/HTTPS URL
+ - &#96;metadata&#96; must be serializable JSON object
+ 
+ ### CaptureResponseMessage
+ 
+ Response from service worker to content script after capture attempt.
+ 
+ **Fields**:
+ - &#96;type: 'CAPTURE_RESPONSE'&#96;
+ - &#96;payload: { success: boolean; itemId?: string; error?: string; errorCategory?: 'permission' | 'cors' | 'storage' | 'validation' }&#96;
+ 
+ **Validation**:
+ - If &#96;success&#96; is true, &#96;itemId&#96; must be present
+ - If &#96;success&#96; is false, &#96;error&#96; and &#96;errorCategory&#96; must be present
+ 
+ ### StorageUpdateMessage
+ 
+ Notification from service worker to UI about storage changes.
+ 
+ **Fields**:
+ - &#96;type: 'STORAGE_UPDATE'&#96;
+ - &#96;payload: { action: 'add' | 'remove' | 'clear' | 'update'; item?: CapturedItem; board?: CapBoard }&#96;
+ 
+ **Validation**:
+ - If &#96;action&#96; is 'add' or 'update', &#96;item&#96; must be present
+ - If &#96;action&#96; is 'clear', &#96;board&#96; must be present (empty items array)
+ 
+ ### ExportRequestMessage
+ 
+ Request from UI to service worker to export board data.
+ 
+ **Fields**:
+ - &#96;type: 'EXPORT_REQUEST'&#96;
+ - &#96;payload: { format: 'json' | 'zip' | 'individual'; options?: ExportOptions }&#96;
+ 
+ **Validation**:
+ - &#96;format&#96; must be one of the allowed values
+ - &#96;options&#96; must be valid ExportOptions if present
+ 
+ ### ExportResponseMessage
+ 
+ Response from service worker to UI after export attempt.
+ 
+ **Fields**:
+ - &#96;type: 'EXPORT_RESPONSE'&#96;
+ - &#96;payload: { success: boolean; filename?: string; error?: string; skippedCount?: number }&#96;
+ 
+ **Validation**:
+ - If &#96;success&#96; is true, &#96;filename&#96; must be present
+ - If &#96;success&#96; is false, &#96;error&#96; must be present
+ - &#96;skippedCount&#96; indicates number of images skipped due to CORS/permissions
+ 
+ ### BoardUpdateMessage
+ 
+ Request to update board state (remove item, clear board).
+ 
+ **Fields**:
+ - &#96;type: 'BOARD_UPDATE'&#96;
+ - &#96;payload: { action: 'remove' | 'clear'; itemId?: string }&#96;
+ 
+ **Validation**:
+ - If &#96;action&#96; is 'remove', &#96;itemId&#96; must be present
+ - If &#96;action&#96; is 'clear', &#96;itemId&#96; must be absent
+ 
+ ### ErrorMessage
+ 
+ Generic error message for any operation.
+ 
+ **Fields**:
+ - &#96;type: 'ERROR'&#96;
+ - &#96;payload: { message: string; category: 'permission' | 'cors' | 'storage' | 'validation' | 'unknown'; retryable: boolean }&#96;
+ 
+ **Validation**:
+ - &#96;message&#96; must be non-empty string (user-friendly, no internal paths)
+ - &#96;category&#96; must be one of the allowed values
+ - &#96;retryable&#96; indicates if action can be retried
+ 
+ ## Relationships
+ 
+ - **CapBoard** contains many **CapturedItem** (1:N)
+ - **CapturedItem** has one **ImageReference** (1:1)
+ - **CapBoard** has one **BoardMetadata** (1:1)
+ - **CapBoard** has one **GridConfig** (1:1)
+ - **CapBoard** may have many **ExportManifest** (1:N, optional)
+ - **ExportManifest** references many **CapturedItem** via **ExportItemReference** (1:N)
+ 
+ ## Storage Mapping
+ 
+ - **CapBoard** → chrome.storage.local (key: &#96;capBoard&#96;)
+ - **ImageReference.blob** → IndexedDB (store: &#96;images&#96;, key: blob reference)
+ - **ExportManifest** → Not stored (generated on export)
+ 
+ ## Validation Summary
+ 
+ All entities must pass schema validation before storage:
+ - URL validation (block javascript:, validate schemes)
+ - Image validation (MIME types, size limits)
+ - Schema validation (structure, required fields)
+ - Storage quota checks (before write operations)
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** • Listed directory, 0 results</summary>
        
No results found
</details>
</tool-use>

---



---


Creating the contracts directory with message type definitions:


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **write** • Edit file: specs/001-capthat-extension/contracts/messages.ts</summary>

**Chunk 1**
Lines added: 291, lines removed: 1

```diff
@@ -1,1 +1,291 @@
- 
+ /**
+  * Message Type Definitions for CapThat Chrome Extension
+  * 
+  * This file defines all message types used for communication between:
+  * - Content Script ↔ Service Worker
+  * - UI (Side Panel) ↔ Service Worker
+  * 
+  * All messages use a discriminated union pattern with a &#96;type&#96; field
+  * for type-safe routing and validation.
+  * 
+  * Task: T027 - Define message types at extension/types/messages.ts
+  */
+ 
+ import type { CapturedItem, CapBoard } from '../data-model';
+ 
+ // ============================================================================
+ // Base Message Structure
+ // ============================================================================
+ 
+ /**
+  * Base interface for all messages in the extension.
+  * All messages must have a &#96;type&#96; field for discriminated union pattern.
+  */
+ export interface BaseMessage {
+   type: string;
+ }
+ 
+ // ============================================================================
+ // Capture Messages
+ // ============================================================================
+ 
+ /**
+  * Request from content script to service worker to capture an image.
+  * 
+  * Sent when user clicks "Cap!" button on an image.
+  */
+ export interface CaptureRequestMessage extends BaseMessage {
+   type: 'CAPTURE_REQUEST';
+   payload: {
+     /** Image URL to capture (HTTP/HTTPS/data URL) */
+     imageUrl: string;
+     /** Source page URL where image was found */
+     sourceUrl: string;
+     /** Optional metadata (title, domain, product link, etc.) */
+     metadata?: Record&lt;string, unknown&gt;;
+   };
+ }
+ 
+ /**
+  * Response from service worker to content script after capture attempt.
+  * 
+  * Indicates success or failure with appropriate error details.
+  */
+ export interface CaptureResponseMessage extends BaseMessage {
+   type: 'CAPTURE_RESPONSE';
+   payload: {
+     /** Whether capture was successful */
+     success: boolean;
+     /** Item ID if capture succeeded */
+     itemId?: string;
+     /** Error message if capture failed (user-friendly, no internal paths) */
+     error?: string;
+     /** Error category for UI handling (permission/CORS/storage/validation) */
+     errorCategory?: 'permission' | 'cors' | 'storage' | 'validation';
+   };
+ }
+ 
+ // ============================================================================
+ // Storage Update Messages
+ // ============================================================================
+ 
+ /**
+  * Notification from service worker to UI about storage changes.
+  * 
+  * Used to update UI when board state changes (item added/removed/cleared).
+  */
+ export interface StorageUpdateMessage extends BaseMessage {
+   type: 'STORAGE_UPDATE';
+   payload: {
+     /** Action that triggered the update */
+     action: 'add' | 'remove' | 'clear' | 'update';
+     /** Captured item (present for 'add' and 'update' actions) */
+     item?: CapturedItem;
+     /** Full board state (present for 'clear' action) */
+     board?: CapBoard;
+   };
+ }
+ 
+ // ============================================================================
+ // Export Messages
+ // ============================================================================
+ 
+ /**
+  * Export format options.
+  */
+ export type ExportFormat = 'json' | 'zip' | 'individual';
+ 
+ /**
+  * Options for export operations.
+  */
+ export interface ExportOptions {
+   /** Include thumbnails in export (default: false) */
+   includeThumbnails?: boolean;
+   /** Maximum file size limit in bytes (default: 100MB) */
+   maxSizeBytes?: number;
+ }
+ 
+ /**
+  * Request from UI to service worker to export board data.
+  * 
+  * Sent when user clicks export buttons (Export JSON, Export CapBoard, Export Individual Caps).
+  */
+ export interface ExportRequestMessage extends BaseMessage {
+   type: 'EXPORT_REQUEST';
+   payload: {
+     /** Export format (json, zip, or individual images) */
+     format: ExportFormat;
+     /** Optional export options */
+     options?: ExportOptions;
+   };
+ }
+ 
+ /**
+  * Response from service worker to UI after export attempt.
+  * 
+  * Indicates success or failure with export details.
+  */
+ export interface ExportResponseMessage extends BaseMessage {
+   type: 'EXPORT_RESPONSE';
+   payload: {
+     /** Whether export was successful */
+     success: boolean;
+     /** Exported filename if successful */
+     filename?: string;
+     /** Error message if export failed */
+     error?: string;
+     /** Number of images skipped due to CORS/permissions */
+     skippedCount?: number;
+   };
+ }
+ 
+ // ============================================================================
+ // Board Update Messages
+ // ============================================================================
+ 
+ /**
+  * Request to update board state (remove item or clear board).
+  * 
+  * Sent from UI to service worker when user removes item or clears board.
+  */
+ export interface BoardUpdateMessage extends BaseMessage {
+   type: 'BOARD_UPDATE';
+   payload: {
+     /** Action to perform */
+     action: 'remove' | 'clear';
+     /** Item ID to remove (required for 'remove' action) */
+     itemId?: string;
+   };
+ }
+ 
+ // ============================================================================
+ // Error Messages
+ // ============================================================================
+ 
+ /**
+  * Error category for error messages.
+  */
+ export type ErrorCategory = 'permission' | 'cors' | 'storage' | 'validation' | 'unknown';
+ 
+ /**
+  * Generic error message for any operation.
+  * 
+  * Used to communicate errors from service worker to content script or UI.
+  */
+ export interface ErrorMessage extends BaseMessage {
+   type: 'ERROR';
+   payload: {
+     /** User-friendly error message (no internal paths exposed) */
+     message: string;
+     /** Error category for UI handling */
+     category: ErrorCategory;
+     /** Whether the action can be retried */
+     retryable: boolean;
+   };
+ }
+ 
+ // ============================================================================
+ // Message Union Type
+ // ============================================================================
+ 
+ /**
+  * Union type of all possible messages in the extension.
+  * 
+  * Used for type-safe message handling and validation.
+  */
+ export type Message =
+   | CaptureRequestMessage
+   | CaptureResponseMessage
+   | StorageUpdateMessage
+   | ExportRequestMessage
+   | ExportResponseMessage
+   | BoardUpdateMessage
+   | ErrorMessage;
+ 
+ // ============================================================================
+ // Type Guards
+ // ============================================================================
+ 
+ /**
+  * Type guard to check if message is a capture request.
+  */
+ export function isCaptureRequestMessage(msg: BaseMessage): msg is CaptureRequestMessage {
+   return msg.type === 'CAPTURE_REQUEST';
+ }
+ 
+ /**
+  * Type guard to check if message is a capture response.
+  */
+ export function isCaptureResponseMessage(msg: BaseMessage): msg is CaptureResponseMessage {
+   return msg.type === 'CAPTURE_RESPONSE';
+ }
+ 
+ /**
+  * Type guard to check if message is a storage update.
+  */
+ export function isStorageUpdateMessage(msg: BaseMessage): msg is StorageUpdateMessage {
+   return msg.type === 'STORAGE_UPDATE';
+ }
+ 
+ /**
+  * Type guard to check if message is an export request.
+  */
+ export function isExportRequestMessage(msg: BaseMessage): msg is ExportRequestMessage {
+   return msg.type === 'EXPORT_REQUEST';
+ }
+ 
+ /**
+  * Type guard to check if message is an export response.
+  */
+ export function isExportResponseMessage(msg: BaseMessage): msg is ExportResponseMessage {
+   return msg.type === 'EXPORT_RESPONSE';
+ }
+ 
+ /**
+  * Type guard to check if message is a board update.
+  */
+ export function isBoardUpdateMessage(msg: BaseMessage): msg is BoardUpdateMessage {
+   return msg.type === 'BOARD_UPDATE';
+ }
+ 
+ /**
+  * Type guard to check if message is an error.
+  */
+ export function isErrorMessage(msg: BaseMessage): msg is ErrorMessage {
+   return msg.type === 'ERROR';
+ }
+ 
+ // ============================================================================
+ // Message Validation
+ // ============================================================================
+ 
+ /**
+  * Validates that a message has the required structure.
+  * 
+  * @param msg - Message to validate
+  * @returns True if message has valid structure
+  */
+ export function isValidMessage(msg: unknown): msg is Message {
+   if (typeof msg !== 'object' || msg === null) {
+     return false;
+   }
+   
+   const baseMsg = msg as BaseMessage;
+   if (typeof baseMsg.type !== 'string') {
+     return false;
+   }
+   
+   // Check if type is one of the known message types
+   const validTypes: Message['type'][] = [
+     'CAPTURE_REQUEST',
+     'CAPTURE_RESPONSE',
+     'STORAGE_UPDATE',
+     'EXPORT_REQUEST',
+     'EXPORT_RESPONSE',
+     'BOARD_UPDATE',
+     'ERROR',
+   ];
+   
+   return validTypes.includes(baseMsg.type as Message['type']);
+ }
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **write** • Edit file: specs/001-capthat-extension/contracts/README.md</summary>

**Chunk 1**
Lines added: 77, lines removed: 1

```diff
@@ -1,1 +1,77 @@
- 
+ # Message Contracts
+ 
+ This directory contains message type definitions for the CapThat Chrome Extension.
+ 
+ ## Files
+ 
+ - **messages.ts** - TypeScript definitions for all message types used in the extension
+ 
+ ## Message Flow
+ 
+ ### Content Script → Service Worker
+ - &#96;CAPTURE_REQUEST&#96; - Request to capture an image
+ 
+ ### Service Worker → Content Script
+ - &#96;CAPTURE_RESPONSE&#96; - Response to capture request
+ - &#96;ERROR&#96; - Error notification
+ 
+ ### UI → Service Worker
+ - &#96;EXPORT_REQUEST&#96; - Request to export board data
+ - &#96;BOARD_UPDATE&#96; - Request to remove item or clear board
+ 
+ ### Service Worker → UI
+ - &#96;STORAGE_UPDATE&#96; - Notification of board state changes
+ - &#96;EXPORT_RESPONSE&#96; - Response to export request
+ - &#96;ERROR&#96; - Error notification
+ 
+ ## Usage
+ 
+ Import message types in your code:
+ 
+ &#96;&#96;&#96;typescript
+ import type { 
+   Message, 
+   CaptureRequestMessage,
+   CaptureResponseMessage 
+ } from './contracts/messages';
+ 
+ // Send message
+ chrome.runtime.sendMessage&lt;CaptureRequestMessage&gt;({
+   type: 'CAPTURE_REQUEST',
+   payload: {
+     imageUrl: 'https://example.com/image.jpg',
+     sourceUrl: 'https://example.com',
+   }
+ });
+ 
+ // Handle message
+ chrome.runtime.onMessage.addListener((msg: Message) =&gt; {
+   if (msg.type === 'CAPTURE_RESPONSE') {
+     // Handle response
+   }
+ });
+ &#96;&#96;&#96;
+ 
+ ## Validation
+ 
+ All messages should be validated using &#96;isValidMessage()&#96; before processing:
+ 
+ &#96;&#96;&#96;typescript
+ import { isValidMessage } from './contracts/messages';
+ 
+ chrome.runtime.onMessage.addListener((msg, sender, sendResponse) =&gt; {
+   if (!isValidMessage(msg)) {
+     sendResponse({ error: 'Invalid message format' });
+     return;
+   }
+   // Process valid message
+ });
+ &#96;&#96;&#96;
+ 
+ ## Task Reference
+ 
+ This contract is part of **T027**: Define message types at &#96;extension/types/messages.ts&#96;
+ 
+ The actual implementation file should be created at:
+ &#96;extension/types/messages.ts&#96;
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Create plan.md from template with Technical Context and Constitution Check
- [x] Generate research.md to resolve any NEEDS CLARIFICATION items
- [x] Generate data-model.md with message type entities
- [x] Generate contracts/ directory with message type definitions
- [-] Generate quickstart.md with message passing examples
- [ ] Update agent context with new technology decisions

</details>
</tool-use>

---



---


Creating quickstart.md with message passing examples:


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **write** • Edit file: specs/001-capthat-extension/quickstart.md</summary>

**Chunk 1**
Lines added: 336, lines removed: 1

```diff
@@ -1,1 +1,336 @@
- 
+ # Quickstart: CapThat Message Passing
+ 
+ **Feature**: 001-capthat-extension  
+ **Date**: 2025-01-27  
+ **Purpose**: Quick reference for implementing message passing in CapThat extension
+ 
+ ## Overview
+ 
+ CapThat uses Chrome Extension message passing (&#96;chrome.runtime.sendMessage&#96; / &#96;chrome.runtime.onMessage&#96;) for communication between:
+ - Content Script ↔ Service Worker
+ - UI (Side Panel) ↔ Service Worker
+ 
+ All messages are type-safe TypeScript interfaces defined in &#96;contracts/messages.ts&#96;.
+ 
+ ## Message Types
+ 
+ ### 1. Capture Request (Content Script → Service Worker)
+ 
+ **When**: User clicks "Cap!" button on an image
+ 
+ &#96;&#96;&#96;typescript
+ import type { CaptureRequestMessage } from '../types/messages';
+ 
+ // In content script
+ chrome.runtime.sendMessage&lt;CaptureRequestMessage&gt;({
+   type: 'CAPTURE_REQUEST',
+   payload: {
+     imageUrl: 'https://example.com/image.jpg',
+     sourceUrl: 'https://example.com',
+     metadata: {
+       title: 'Example Image',
+       domain: 'example.com',
+     },
+   }
+ }, (response) =&gt; {
+   // Handle response (CaptureResponseMessage)
+   if (response?.success) {
+     console.log('Image captured:', response.itemId);
+   } else {
+     console.error('Capture failed:', response?.error);
+   }
+ });
+ &#96;&#96;&#96;
+ 
+ ### 2. Capture Response (Service Worker → Content Script)
+ 
+ **When**: Service worker completes capture attempt
+ 
+ &#96;&#96;&#96;typescript
+ import type { CaptureResponseMessage } from '../types/messages';
+ 
+ // In service worker
+ function handleCaptureRequest(msg: CaptureRequestMessage, sendResponse: (response: CaptureResponseMessage) =&gt; void) {
+   try {
+     // Perform capture logic...
+     const itemId = 'generated-uuid';
+     
+     sendResponse({
+       type: 'CAPTURE_RESPONSE',
+       payload: {
+         success: true,
+         itemId: itemId,
+       },
+     });
+   } catch (error) {
+     sendResponse({
+       type: 'CAPTURE_RESPONSE',
+       payload: {
+         success: false,
+         error: 'Failed to capture image',
+         errorCategory: 'storage',
+       },
+     });
+   }
+ }
+ &#96;&#96;&#96;
+ 
+ ### 3. Storage Update (Service Worker → UI)
+ 
+ **When**: Board state changes (item added/removed/cleared)
+ 
+ &#96;&#96;&#96;typescript
+ import type { StorageUpdateMessage } from '../types/messages';
+ 
+ // In service worker (after saving item)
+ function notifyUIUpdate(item: CapturedItem) {
+   chrome.runtime.sendMessage&lt;StorageUpdateMessage&gt;({
+     type: 'STORAGE_UPDATE',
+     payload: {
+       action: 'add',
+       item: item,
+     },
+   });
+ }
+ 
+ // In UI (side panel)
+ chrome.runtime.onMessage.addListener((msg) =&gt; {
+   if (msg.type === 'STORAGE_UPDATE') {
+     const update = msg as StorageUpdateMessage;
+     if (update.payload.action === 'add' &amp;&amp; update.payload.item) {
+       // Update UI with new item
+       addItemToGrid(update.payload.item);
+     }
+   }
+ });
+ &#96;&#96;&#96;
+ 
+ ### 4. Export Request (UI → Service Worker)
+ 
+ **When**: User clicks export button (Export JSON, Export CapBoard, Export Individual Caps)
+ 
+ &#96;&#96;&#96;typescript
+ import type { ExportRequestMessage } from '../types/messages';
+ 
+ // In UI (side panel)
+ function handleExportClick(format: 'json' | 'zip' | 'individual') {
+   chrome.runtime.sendMessage&lt;ExportRequestMessage&gt;({
+     type: 'EXPORT_REQUEST',
+     payload: {
+       format: format,
+       options: {
+         includeThumbnails: false,
+         maxSizeBytes: 100 * 1024 * 1024, // 100MB
+       },
+     }
+   }, (response) =&gt; {
+     // Handle response (ExportResponseMessage)
+     if (response?.success) {
+       showToast(&#96;Exported: ${response.filename}&#96;);
+     } else {
+       showError(&#96;Export failed: ${response?.error}&#96;);
+     }
+   });
+ }
+ &#96;&#96;&#96;
+ 
+ ### 5. Board Update (UI → Service Worker)
+ 
+ **When**: User removes item or clears board
+ 
+ &#96;&#96;&#96;typescript
+ import type { BoardUpdateMessage } from '../types/messages';
+ 
+ // In UI (side panel)
+ function removeItem(itemId: string) {
+   chrome.runtime.sendMessage&lt;BoardUpdateMessage&gt;({
+     type: 'BOARD_UPDATE',
+     payload: {
+       action: 'remove',
+       itemId: itemId,
+     }
+   }, (response) =&gt; {
+     if (response?.success) {
+       // Item removed, UI will receive STORAGE_UPDATE message
+     }
+   });
+ }
+ 
+ function clearBoard() {
+   if (confirm('Clear all items?')) {
+     chrome.runtime.sendMessage&lt;BoardUpdateMessage&gt;({
+       type: 'BOARD_UPDATE',
+       payload: {
+         action: 'clear',
+       }
+     });
+   }
+ }
+ &#96;&#96;&#96;
+ 
+ ## Service Worker Message Handler
+ 
+ Complete example of service worker message routing:
+ 
+ &#96;&#96;&#96;typescript
+ import type { Message } from '../types/messages';
+ import { 
+   isValidMessage,
+   isCaptureRequestMessage,
+   isExportRequestMessage,
+   isBoardUpdateMessage,
+ } from '../types/messages';
+ 
+ chrome.runtime.onMessage.addListener((msg: unknown, sender, sendResponse) =&gt; {
+   // Validate message structure
+   if (!isValidMessage(msg)) {
+     sendResponse({
+       type: 'ERROR',
+       payload: {
+         message: 'Invalid message format',
+         category: 'validation',
+         retryable: false,
+       },
+     });
+     return true; // Keep channel open for async response
+   }
+ 
+   // Route message by type
+   if (isCaptureRequestMessage(msg)) {
+     handleCaptureRequest(msg, sendResponse);
+   } else if (isExportRequestMessage(msg)) {
+     handleExportRequest(msg, sendResponse);
+   } else if (isBoardUpdateMessage(msg)) {
+     handleBoardUpdate(msg, sendResponse);
+   } else {
+     sendResponse({
+       type: 'ERROR',
+       payload: {
+         message: 'Unknown message type',
+         category: 'validation',
+         retryable: false,
+       },
+     });
+   }
+ 
+   return true; // Keep channel open for async response
+ });
+ &#96;&#96;&#96;
+ 
+ ## Content Script Message Handler
+ 
+ Example of content script receiving messages:
+ 
+ &#96;&#96;&#96;typescript
+ import type { Message } from '../types/messages';
+ import { isCaptureResponseMessage, isErrorMessage } from '../types/messages';
+ 
+ chrome.runtime.onMessage.addListener((msg: Message) =&gt; {
+   if (isCaptureResponseMessage(msg)) {
+     if (msg.payload.success) {
+       // Show success feedback
+       showToast('Image captured!');
+     } else {
+       // Show error feedback
+       showError(msg.payload.error || 'Capture failed');
+     }
+   } else if (isErrorMessage(msg)) {
+     // Handle generic error
+     showError(msg.payload.message);
+   }
+   
+   return true;
+ });
+ &#96;&#96;&#96;
+ 
+ ## Error Handling
+ 
+ All messages should handle errors gracefully:
+ 
+ &#96;&#96;&#96;typescript
+ // In content script
+ chrome.runtime.sendMessage(message, (response) =&gt; {
+   if (chrome.runtime.lastError) {
+     // Handle Chrome API error
+     console.error('Message error:', chrome.runtime.lastError.message);
+     showError('Failed to communicate with extension');
+     return;
+   }
+   
+   // Handle response
+   if (response?.type === 'ERROR') {
+     const error = response as ErrorMessage;
+     showError(error.payload.message);
+     if (error.payload.retryable) {
+       // Show retry button
+     }
+   }
+ });
+ &#96;&#96;&#96;
+ 
+ ## Type Safety
+ 
+ Always use TypeScript types for messages:
+ 
+ &#96;&#96;&#96;typescript
+ import type { 
+   Message,
+   CaptureRequestMessage,
+   CaptureResponseMessage 
+ } from '../types/messages';
+ 
+ // Type-safe message sending
+ function sendCaptureRequest(imageUrl: string, sourceUrl: string) {
+   const message: CaptureRequestMessage = {
+     type: 'CAPTURE_REQUEST',
+     payload: {
+       imageUrl,
+       sourceUrl,
+     },
+   };
+   
+   chrome.runtime.sendMessage(message, (response: CaptureResponseMessage) =&gt; {
+     // TypeScript knows response structure
+     if (response.payload.success) {
+       console.log('Item ID:', response.payload.itemId);
+     }
+   });
+ }
+ &#96;&#96;&#96;
+ 
+ ## Testing
+ 
+ Test message passing in Chrome DevTools:
+ 
+ &#96;&#96;&#96;javascript
+ // In content script console
+ chrome.runtime.sendMessage({
+   type: 'CAPTURE_REQUEST',
+   payload: {
+     imageUrl: 'https://example.com/test.jpg',
+     sourceUrl: 'https://example.com',
+   }
+ }, (response) =&gt; {
+   console.log('Response:', response);
+ });
+ 
+ // In service worker console
+ chrome.runtime.onMessage.addListener((msg) =&gt; {
+   console.log('Received:', msg);
+ });
+ &#96;&#96;&#96;
+ 
+ ## Next Steps
+ 
+ 1. Implement message handlers in &#96;extension/background/service-worker.ts&#96;
+ 2. Implement message senders in &#96;extension/content/content-script.ts&#96;
+ 3. Implement message handlers in &#96;extension/ui/side-panel.tsx&#96;
+ 4. Add message validation using &#96;isValidMessage()&#96; at all boundaries
+ 5. Test message flow end-to-end
+ 
+ ## References
+ 
+ - Message Type Definitions: &#96;contracts/messages.ts&#96;
+ - Data Model: &#96;data-model.md&#96;
+ - Chrome Extension Messaging: https://developer.chrome.com/docs/extensions/mv3/messaging/
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Create plan.md from template with Technical Context and Constitution Check
- [x] Generate research.md to resolve any NEEDS CLARIFICATION items
- [x] Generate data-model.md with message type entities
- [x] Generate contracts/ directory with message type definitions
- [x] Generate quickstart.md with message passing examples
- [-] Update agent context with new technology decisions

</details>
</tool-use>

---



---


Checking the agent context update script:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: .specify/scripts/bash/update-agent-context.sh</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "Where is the cursor agent context file that stores technology decisions and should be updated?" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `.cursor/commands/speckit.plan.md` | L53-89 |
| `.specify/scripts/bash/update-agent-context.sh` | L355-417 |
| `.specify/scripts/bash/update-agent-context.sh` | L46-121 |
| `.specify/scripts/bash/update-agent-context.sh` | L49 |
| `.specify/scripts/bash/update-agent-context.sh` | L266-322 |
| `.cursor/commands/speckit.plan.md` | L56 |
| `.specify/scripts/bash/update-agent-context.sh` | L454-509 |
| `.cursor/commands/speckit.checklist.md` | L61-89 |
| `.specify/scripts/bash/update-agent-context.sh` | L638-718 |
| `.specify/templates/agent-file-template.md` | L28 |
| `.cursorindexingignore` | L3 |
| `.cursor/commands/speckit.tasks.md` | L42 |
| `.specify/scripts/bash/update-agent-context.sh` | L320-363 |
| `.specify/scripts/bash/update-agent-context.sh` | L505-556 |
| `.cursor/commands/speckit.analyze.md` | L156-184 |

</details>
</tool-use>

---



---


Checking for a Cursor agent context file and updating it manually since bash isn't available:


---

<tool-use data-tool-type="generic" data-tool-name="glob_file_search">
<details>
<summary>Tool use: **glob_file_search** • Searched codebase "**/.cursor/rules/*.mdc" • **0** result in **1** directory</summary>

Directory: **c:\dev\capthat\cap-that** (0 file)

</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="glob_file_search">
<details>
<summary>Tool use: **glob_file_search** • Searched codebase "**/.cursor/**/*.md" • **0** result in **1** directory</summary>

Directory: **c:\dev\capthat\cap-that** (0 file)

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: .specify/templates/agent-file-template.md</summary>

</details>
</tool-use>

---



---


Creating the Cursor agent context file manually since the script requires bash:


---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** • Listed directory, 0 results</summary>
        
No results found
</details>
</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **write** • Edit file: .cursor/rules/specify-rules.mdc</summary>

**Chunk 1**
Lines added: 121, lines removed: 1

```diff
@@ -1,1 +1,121 @@
- 
+ # Cap That Development Guidelines
+ 
+ Auto-generated from all feature plans. Last updated: 2025-01-27
+ 
+ ## Active Technologies
+ 
+ - TypeScript 5.x + React 19.2.1 + Tailwind CSS 4.x (001-capthat-extension)
+ - Chrome Extension APIs (MV3) (001-capthat-extension)
+ - Vite 5.4.0 (001-capthat-extension)
+ - Next.js 16.0.10 (001-capthat-extension)
+ - JSZip (001-capthat-extension)
+ 
+ ## Project Structure
+ 
+ &#96;&#96;&#96;text
+ cap-that/
+ ├── extension/                          # Chrome Extension
+ │   ├── manifest.json                   # MV3 manifest
+ │   ├── background/
+ │   │   └── service-worker.ts          # Background service worker
+ │   ├── content/
+ │   │   └── content-script.ts          # Content script injection
+ │   ├── ui/
+ │   │   ├── side-panel.html            # Side panel HTML
+ │   │   ├── side-panel.tsx             # React component
+ │   │   └── components/                # UI components
+ │   ├── storage/
+ │   │   ├── storage-adapter.ts          # chrome.storage wrapper
+ │   │   └── indexeddb-adapter.ts       # IndexedDB wrapper
+ │   ├── export/
+ │   │   ├── json-export.ts              # JSON export logic
+ │   │   ├── zip-export.ts               # ZIP export logic
+ │   │   └── filename-sanitizer.ts       # Filename sanitization
+ │   ├── validation/
+ │   │   ├── url-validator.ts            # URL validation
+ │   │   ├── image-validator.ts          # Image validation
+ │   │   └── schema-validator.ts         # Data schema validation
+ │   └── types/
+ │       ├── index.ts                    # TypeScript types
+ │       └── messages.ts                 # Message type definitions
+ │
+ ├── app/                                # Next.js App (Phase 2)
+ │   ├── api/
+ │   │   └── capture/
+ │   │       └── route.ts                # POST /api/capture
+ │   ├── board/
+ │   │   └── page.tsx                    # Board view page
+ │   └── layout.tsx                      # Root layout
+ │
+ ├── shared/                             # Shared code
+ │   ├── types/
+ │   │   └── index.ts                    # Shared TypeScript types
+ │   ├── validators/
+ │   │   └── url.ts                      # URL validation
+ │   └── storage/
+ │       └── adapters.ts                 # Storage interface
+ &#96;&#96;&#96;
+ 
+ ## Commands
+ 
+ ### TypeScript
+ - Build extension: &#96;npm run build:extension&#96;
+ - Build all: &#96;npm run build:all&#96;
+ - Type check: &#96;tsc --noEmit&#96;
+ 
+ ### Chrome Extension
+ - Load unpacked: Open &#96;chrome://extensions&#96;, enable Developer mode, click "Load unpacked", select &#96;extension/&#96; directory
+ - Reload extension: Click reload button in chrome://extensions after code changes
+ 
+ ### Next.js
+ - Dev server: &#96;npm run dev&#96;
+ - Build: &#96;npm run build&#96;
+ - Start: &#96;npm start&#96;
+ 
+ ## Code Style
+ 
+ ### TypeScript
+ - Use strict TypeScript configuration
+ - Prefer interfaces over types for object shapes
+ - Use discriminated unions for message types
+ - Add JSDoc comments for exported functions
+ - Use descriptive variable and function names
+ 
+ ### React
+ - Use functional components and hooks
+ - Prefer composition over inheritance
+ - Keep components focused and single-purpose
+ - Use TypeScript for all components
+ 
+ ### Chrome Extension
+ - Follow MV3 patterns (service worker, no background pages)
+ - Use isolated world for content scripts
+ - Validate all messages at boundaries
+ - Implement strict CSP (no eval, no inline scripts)
+ - Request minimal permissions (activeTab over *://*/*)
+ 
+ ## Recent Changes
+ 
+ - 001-capthat-extension: Added TypeScript + React + Tailwind CSS for Chrome Extension with message passing architecture
+ 
+ ## Message Passing Architecture
+ 
+ All communication between extension components uses type-safe message passing:
+ 
+ - **Content Script ↔ Service Worker**: &#96;chrome.runtime.sendMessage&#96; / &#96;chrome.runtime.onMessage&#96;
+ - **UI ↔ Service Worker**: &#96;chrome.runtime.sendMessage&#96; / &#96;chrome.runtime.onMessage&#96;
+ - **Message Types**: Defined in &#96;extension/types/messages.ts&#96; (see &#96;specs/001-capthat-extension/contracts/messages.ts&#96; for reference)
+ - **Validation**: All messages validated using &#96;isValidMessage()&#96; at boundaries
+ 
+ Key message types:
+ - &#96;CAPTURE_REQUEST&#96; / &#96;CAPTURE_RESPONSE&#96; - Image capture
+ - &#96;STORAGE_UPDATE&#96; - Board state changes
+ - &#96;EXPORT_REQUEST&#96; / &#96;EXPORT_RESPONSE&#96; - Export operations
+ - &#96;BOARD_UPDATE&#96; - Remove item / clear board
+ - &#96;ERROR&#96; - Error notifications
+ 
+ See &#96;specs/001-capthat-extension/quickstart.md&#96; for usage examples.
+ 
+ &lt;!-- MANUAL ADDITIONS START --&gt;
+ &lt;!-- MANUAL ADDITIONS END --&gt;
+ 
```

</details>

</tool-use>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Create plan.md from template with Technical Context and Constitution Check
- [x] Generate research.md to resolve any NEEDS CLARIFICATION items
- [x] Generate data-model.md with message type entities
- [x] Generate contracts/ directory with message type definitions
- [x] Generate quickstart.md with message passing examples
- [x] Update agent context with new technology decisions

</details>
</tool-use>

---



---


Checking for linting errors and preparing the final summary:


---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 2 files</summary>
      
Lint paths:

- `specs/001-capthat-extension/plan.md`
- `specs/001-capthat-extension/contracts/messages.ts`

Lint results


**No lint errors found**
</details>
</tool-use>

---



---


## Implementation plan complete

### Generated artifacts

1. **`specs/001-capthat-extension/plan.md`**
   - Technical context (TypeScript, React, Chrome Extension MV3)
   - Constitution check (all principles met)
   - Project structure documented

2. **`specs/001-capthat-extension/research.md`**
   - Message passing patterns (chrome.runtime.sendMessage)
   - Storage strategy (chrome.storage.local + IndexedDB)
   - CORS handling strategy
   - Technology decisions documented

3. **`specs/001-capthat-extension/data-model.md`**
   - Core entities (CapturedItem, CapBoard, ImageReference, etc.)
   - Message type entities (T027 focus)
   - Validation rules and relationships

4. **`specs/001-capthat-extension/contracts/messages.ts`**
   - TypeScript message type definitions (T027 deliverable)
   - Discriminated union pattern for type safety
   - Type guards and validation functions
   - All message types: CAPTURE_REQUEST, CAPTURE_RESPONSE, STORAGE_UPDATE, EXPORT_REQUEST, EXPORT_RESPONSE, BOARD_UPDATE, ERROR

5. **`specs/001-capthat-extension/contracts/README.md`**
   - Documentation for message contracts
   - Usage examples and validation guidelines

6. **`specs/001-capthat-extension/quickstart.md`**
   - Message passing examples
   - Service worker and content script handlers
   - Error handling patterns
   - Type safety examples

7. **`.cursor/rules/specify-rules.mdc`**
   - Agent context updated with technology stack
   - Message passing architecture documented
   - Project structure and commands

### T027 focus: Message types

The message type definitions are in `specs/001-capthat-extension/contracts/messages.ts` and include:
- 7 message types with TypeScript interfaces
- Type guards for runtime validation
- Validation function (`isValidMessage`)
- Documentation and examples

### Next steps

1. Copy `contracts/messages.ts` to `extension/types/messages.ts` for implementation
2. Implement message handlers in service worker and content script
3. Use the quickstart guide for integration examples

### Branch and paths

- **Branch**: `001-capthat-extension`
- **Plan Path**: `specs/001-capthat-extension/plan.md`
- **Contracts Path**: `specs/001-capthat-extension/contracts/`

All artifacts are ready for the implementation phase. The message type definitions (T027) are complete and ready to be integrated into the extension codebase.

---

